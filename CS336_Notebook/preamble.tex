\usepackage[utf8]{inputenc}
\usepackage[T1]{fontenc}
\usepackage{amsmath,amssymb,amsthm}
\usepackage{fourier-otf}
\usepackage{marginnote,sidenotes}
\renewcommand*{\raggedrightmarginnote}{\noindent}
\renewcommand*{\raggedleftmarginnote}{\noindent}
\usepackage{cabin}
\usepackage[nomarginpar]{geometry}
\usepackage{etoolbox}
\usepackage{microtype}
\usepackage{lettrine}
\usepackage{tabularx}
\usepackage{fancyhdr}
\pagestyle{fancy}
\RequirePackage{marginfix}% automatically adjust the side-floats nicely 
\usepackage{array,tabularx,booktabs} 
\newcolumntype{C}[1]{>{\centering\arraybackslash}p{#1}}  % 自定义列格式
\usepackage{titletoc}
\usepackage{graphicx}
\setlength{\marginparwidth}{2.8cm}
\usepackage{mathtools}
\usepackage{tikz}
\usetikzlibrary{calc}
\usepackage[labelfont=bf,textfont=md]{caption}
\usepackage{capt-of}
 \usepackage{dsfont}
 % \usepackage{nicefrac}
\usepackage{amsfonts}
\usepackage{tcolorbox}
\tcbuselibrary{breakable,skins}
\usepackage{soulutf8}   % 代替 soul，支持 UTF-8 高亮
\usepackage{xcolor}      % 定义颜色
\sethlcolor{yellow} 
\usepackage{enumitem}
\usepackage[colorlinks=true,    % 链接文字带颜色
            linkcolor=blue,     % 文内交叉引用链接颜色
            urlcolor=cyan,      % \url 链接颜色
            citecolor=magenta   % 文献引用链接颜色
           ]{hyperref}
\usepackage{cleveref}
\usepackage{sidenotes}
\crefformat{figure}{#2{\color{violet}#1}#3}
\usepackage{pgfplots}
\usepgfplotslibrary{colormaps}
\usepackage{fontspec,unicode-math}
\tcbuselibrary{breakable}
\usepackage[ruled,vlined]{algorithm2e}
\usepackage{algpseudocode}
\usepackage{xeCJK}
\setmainfont{Times New Roman} % 英文
\setCJKmainfont{Noto Sans CJK SC} 
\usepackage{subcaption}
\usepackage{float} 
\usepackage{listings}
\usepackage{bookmark}

%\renewcommand{\familydefault}{\sfdefault}
%%%%%%%%%%COLORS%%%%%%%%%%%%%%%%%%%


\definecolor{dgreen}{RGB}{0,154,84}
\definecolor{sgreen}{RGB}{238,247,244}
\definecolor{zgreen}{RGB}{56,129,93}

\definecolor{dblue}{RGB}{0,110,185}
\definecolor{sblue}{RGB}{240,243,250}
\definecolor{zblue}{RGB}{65,106,150}
\definecolor{nblue}{RGB}{212,244,245}
\definecolor{tblue}{RGB}{0,163,211}

\definecolor{nred}{RGB}{245,213,212}
\definecolor{tred}{RGB}{211,48,0}

\definecolor{royalpurple}{RGB}{120,81,169}


\definecolor{qpurple}{RGB}{102,0,153}   % 深紫
\definecolor{slilac}{RGB}{230,220,255}  % 淡紫
\definecolor{apink}{RGB}{204,0,102}     % 深粉红
\definecolor{spink}{RGB}{255,230,240}   % 淡粉红


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%%%%%%%%%%%%%NEWCOMMANDS%%%%%%%%%%%%%%

\newcommand{\dis}{\displaystyle}
\newcommand{\bi}{\begin{itemize}}
\newcommand{\ei}{\end{itemize}}
\newcommand{\bn}{\begin{enumerate}}
\newcommand{\en}{\end{enumerate}}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\setcounter{tocdepth}{3}



%%%%%%%%%GEOMETRY%%%%%%%%%%%%

\RequirePackage{geometry}
\geometry{
paperwidth=210mm,
paperheight=297mm,
left=42pt,
top=72pt,
textwidth=350pt,
marginparsep=20pt,
marginparwidth=140pt,
textheight=650pt,
footskip=40pt,
}





%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


%%%%%%%%%%LETTER SPACING%%%%%%%%%%%%%%%%%
\renewcommand{\normalsize}{\fontsize{10pt}{13pt}\selectfont}%
\renewcommand{\footnotesize}{\fontsize{8pt}{10pt}\selectfont}%
% fullwidth environment, text across textwidth+marginparsep+marginparwidth
\newlength{\overhang}
\setlength{\overhang}{\marginparwidth}
\addtolength{\overhang}{\marginparsep}
%
\newenvironment{fullwidth}
  {\ifthenelse{\boolean{@twoside}}%
     {\begin{adjustwidth*}{}{-\overhang}}%
     {\begin{adjustwidth}{}{-\overhang}}%
  }%
  {\ifthenelse{\boolean{@twoside}}%
    {\end{adjustwidth*}}%
    {\end{adjustwidth}}%
  }

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\renewcommand{\headrulewidth}{0pt}
\renewcommand{\footrulewidth}{0pt}
\renewcommand{\chaptername}{Lecture}



%%%%%%%%%%%CHAPTER HEADER %%%%%%%%%%%%%%%%%%

\renewcommand{\sffamily}{\color{TFFrameColor}}
\renewcommand\LettrineTextFont{\color{TFFrameColor}\scshape}
\usepackage[x11names]{xcolor}
\newcommand*\ftsize[1]{\fontsize{#1pt}{\numexpr 1.2*#1\relax pt}\selectfont}
\usepackage{colortbl}
\usepackage{framed}
\colorlet{TFFrameColor}{DodgerBlue3}
\renewenvironment{leftbar}{%
\def\FrameCommand{{\color{TFFrameColor}\vrule width 3pt} \hspace{12pt}}%
\MakeFramed {\advance\hsize-\width \FrameRestore}}%
{\endMakeFramed}
\usepackage[explicit,newlinetospace]{titlesec}

% New command to set the chapter abstract
\newcommand{\chapterabstracttext}{}

\newcommand{\setchapterabstract}[1]{%
  \renewcommand{\chapterabstracttext}{%
    {\small\textit{Lecture abstract: }#1}\vspace{-1\baselineskip}%
  }%
}



\titleformat{\chapter}[hang]%
{\usefont{T1}{phv}{m}{n}}% Font settings
{%
  \parbox[t]{\dimexpr0.12\linewidth-20pt\relax}{\fontsize{48}{48}\selectfont\raisebox{-1.25\height}{\color{TFFrameColor}\thechapter}}%
}%
{1em}%
{%
  \begin{minipage}[t]{1.36\textwidth}% Set to full text width
    \begin{leftbar}%
      {\bfseries\fontsize{24}{30}\selectfont\color{TFFrameColor}%
        \rule{0pt}{2ex}\strut #1\hfil\vskip2ex\break%
      }%
      \chapterabstracttext%
      \rule[-1.5ex]{0pt}{1.5ex}%
    \end{leftbar}%
  \end{minipage}%
}
\titlespacing{\chapter}{0pt}{2\baselineskip}{6\baselineskip}



%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%



%%%%%%%%%%%%%SECTION HEADER%%%%%%%%%%%%%%%%%%



\titleformat{\section}
  {\LettrineTextFont\Large\bfseries\color{black}}
  {\thesection}
  {1em}
  {#1}
  [{\color{DodgerBlue3}\titlerule[0.8pt]}]


\titleformat{\subsection}
  {\LettrineTextFont\Large\bfseries\color{black}}
  {\thesubsection}
  {1em}
  {#1}
  [{\color{DodgerBlue3}\titlerule[0.8pt]}]



%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


%%%%%%%%%%%%%%SIDE NOTE%%%%%%%%%%%%%%%%%%

% 统一用于边栏注释（文字/图像），无编号，自动避让
\renewcommand*{\raggedleftmarginnote}{\noindent}
\renewcommand*{\raggedrightmarginnote}{\noindent}
\newcommand{\mn}[1]{\textsuperscript{\thesidenote}{}\marginnote{\textsuperscript{\thesidenote}{}\itshape\footnotesize #1}\refstepcounter{sidenote}}
\newcommand{\fn}[1]{\marginnote{\footnotesize{#1}}}
\newcommand{\lec}[2]{{\setlength{\marginparwidth}{.07\paperwidth}\reversemarginpar\marginnote{\centering\footnotesize{\textsf{\bfseries #1}}\\#2}}}
\newcommand{\sn}[1]{\sidenote{\footnotesize #1}}


\newcommand{\MarginImage}[2]{%
  \marginpar{%
    \centering
    \includegraphics[width=\marginparwidth]{#1}\\
    \footnotesize 
    #2
  }%
}

\newcommand{\MarginNote}[1]{%
  \marginpar{%
    \flushleft
    {\footnotesize #1} % 把所有内容包进 footnotesize
  }%
}


% —— 在导言区或你自己的宏文件中，添加这个新宏 —— 
\newcommand{\MarginImageWithNote}[3]{%
  % 参数 #1：图片路径
  % 参数 #2：caption 内容（包含 \captionof{figure}{...}）
  % 参数 #3：对应的 margin 注释文本
  \MarginImage{#1}{#2}%
  \MarginNote{#3}%
}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


%%%%%%%%%%%%%%%%%%MARGIN TOC%%%%%%%%%%

\newcommand{\chaptoc}{
    \startcontents[chapters]
  \marginnote{
    \begin{minipage}[b,inner sep=0,outer sep=0]{\linewidth}
           { 
            \bfseries
            \sffamily
             \centerline{Outline}
        }
        \vspace{0.5em}
        \hrule
        \vspace{0.5em}
        {\footnotesize % Change the font size here to small
                \printcontents[chapters]{}{1}{}
            }
        \vspace{0.5em}
        \hrule
        \end{minipage}
}}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%



%%%%%%%%%%%%%%%%THEOREMBOXES%%%%%%%%%%%%%%%%%%%%


\NewTotalTColorBox{\Example}{+m +m}{
notitle,
colback=sgreen,
colbacklower=white, 
frame hidden,
boxrule=0pt,
bicolor,
sharp corners,
borderline west={4pt}{0pt}{dgreen},
}{
  \sffamily
  \textbf{{\color{dgreen}Example~\thetcbcounter:}}~\textbf{{\color{dgreen}#1}} \\[0.5em]
      {\color{black}#2}
} 


\NewTotalTColorBox{\Insight}{+m +m}{ 
  notitle,
  colback=nred,
  colbacklower=white,
  frame hidden,
  boxrule=0pt,
  bicolor,
  sharp corners,
  borderline west={4pt}{0pt}{tred},
}{
  \sffamily
  \textbf{{\color{tred}Insight~\thetcbcounter:}}~\textbf{{\color{tred}#1}} \\[0.5em]
  {\color{black}#2}
}



\NewTotalTColorBox[auto counter]{\Definition}{+m +m}{ 
  notitle,
  colback=sblue,
  colbacklower=white,
  frame hidden,
  boxrule=0pt,
  bicolor,
  sharp corners,
  borderline west={4pt}{0pt}{dblue},
}{
  \sffamily
  \textbf{{\color{dblue}Definition~\thetcbcounter:}}~\textbf{{\color{dblue}#1}} \\[0.5em]
  {\color{black}#2}
}





\NewTotalTColorBox{\Remark}{+m +m}{
notitle,
colback=orange!5,
colbacklower=white, 
frame hidden,
boxrule=0pt,
bicolor,
sharp corners,
borderline west={4pt}{0pt}{orange},
}{
\textcolor{black}{
\sffamily
\textbf{{\color{orange}Remark~\thetcbcounter.}} \\
{\color{black} #1}
}%
}


\NewTotalTColorBox{\QA}{+m +m}{
  notitle,
  colback=slilac,           % 背景色（Question 部分）
  colbacklower=spink,       % 下半部分背景色（Answer 部分）
  frame hidden,
  boxrule=0pt,
  bicolor,
  sharp corners,
  borderline west={4pt}{0pt}{qpurple}, % 左边框深紫色
}{
  \sffamily
  % Question 标题
  \textbf{{\color{qpurple}Question~\thetcbcounter:}}~{\color{black}#1} \\[0.5em]
  % Answer 标题
  \textbf{{\color{apink}Answer:}}~{\color{black}#2}
}


\NewTotalTColorBox[auto counter]{\Proposition}{+m +m}{
notitle,
colback=royalpurple!7,
colbacklower=white, 
frame hidden,
boxrule=0pt,
bicolor,
sharp corners,
borderline west={4pt}{0pt}{royalpurple},
}{
\textcolor{royalpurple}{
\sffamily
\textbf{{\color{royalpurple}Proposition~\thetcbcounter.}} \\% 
}%
{\color{black}#1}
\tcblower%
\textcolor{royalpurple}{
\sffamily 
\textbf{{\color{royalpurple}Proof.}$\;$}%
}%
#2
}
%%%%%highlight
\newcommand{\CJKhl}[1]{%
  \begingroup
    \setlength{\fboxsep}{1pt}% 内边距
    \colorbox{yellow!50}{\strut#1}% \strut 保持行高
  \endgroup
}

%%%%%code

\lstset{
    basicstyle=\ttfamily\small,
    keywordstyle=\color{blue},
    commentstyle=\color{gray},
    stringstyle=\color{orange},
    showstringspaces=false,
    breaklines=true
}
